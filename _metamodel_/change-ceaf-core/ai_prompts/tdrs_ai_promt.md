# Инструкция по работе с моделью TDR

## 1. Заполнение модели TDR

### 1.1 Назначение
Данный файл содержит инструкции для ИИ по взаимодействию с пользователем при работе с моделью TDR.

### 1.2 Модель взаимодействия

1. Проверка структуры документа:
   - Шаг 1: Сравнение с базовой моделью
     * Загрузить текущий TDR документ и базовую модель (`tdr_model.md`)
     * Сравнить все заголовки по уровням (###, ####, etc.)
     * Сравнить все вопросы (строки, начинающиеся с "- ▢" или "- ▣")
   - Шаг 2: Обработка различий
     * При обнаружении изменений в TDR документе:
       + Если изменение улучшает модель - предложить обновить базовую модель
       + Если изменение случайное - предложить восстановить из базовой модели
     * Представить пользователю список различий в формате:
       + "Заголовок/вопрос в базовой модели: [текст]"
       + "Заголовок/вопрос в текущем документе: [текст]"
       + "Рекомендуемое действие: [обновить модель/восстановить из модели]"
   - Шаг 3: Согласование изменений
     * Получить от пользователя решение по каждому различию
     * При решении обновить модель - сначала получить подтверждение
     * При решении восстановить - показать точные изменения в документе
   - Шаг 4: Применение изменений
     * Обновить базовую модель и/или текущий документ согласно решениям
     * Показать итоговый результат пользователю
     * Получить финальное подтверждение корректности структуры

2. Обработка разделов TDR:
   - Шаг 1: Определение порядка обхода
     * Начать с первого раздела документа (сверху вниз)
     * Внутри раздела - сверху вниз по вопросам
     * При наличии подразделов - сначала завершить текущий
   - Шаг 2: Анализ текущего раздела
     * Определить все вопросы раздела по маркерам (▢ или ▣)
     * Проверить статус каждого вопроса по алгоритму из раздела 1.6
     * Найти первый неотвеченный вопрос (с маркером ▢)
   - Шаг 3: Анализ контекста для вопроса
     * Собрать все ответы от начала документа до текущего вопроса
     * Проверить связи с другими разделами документа
     * Определить, достаточно ли контекста для ответа

3. Работа с вопросами:
   - Шаг 1: Структура предложения ответа
     * Указать на какой контекст опирается ответ
     * Представить ответ в формате:
       + Краткий ответ на вопрос (1-2 предложения)
       + Развернутое обоснование (если требуется)
       + Связи с другими разделами (если есть)
   - Шаг 2: Получение обратной связи
     * Спросить пользователя о корректности ответа
     * Принять один из вариантов:
       + Полное подтверждение - переход к внесению изменений
       + Частичное подтверждение - уточнить что именно нужно изменить
       + Отклонение - запросить причины и начать заново
   - Шаг 3: Обработка корректировок
     * При частичном подтверждении:
       + Внести только подтвержденные части
       + Переработать остальные части согласно замечаниям
     * При полном отклонении:
       + Зафиксировать причины отклонения
       + Использовать их при формировании нового ответа

4. Внесение изменений:
   - Шаг 1: Подготовка изменений
     * Проверить формат ответа:
       + Ответ начинается с ">" после вопроса
       + Каждая новая строка ответа начинается с ">"
       + Сохраняется иерархия списков (если есть)
     * Подготовить маркировку:
       + Изменить маркер с ▢ на ▣
   - Шаг 2: Проверка корректности
     * Убедиться что изменения затрагивают только ответ
     * Проверить сохранение структуры документа
     * Проверить соответствие формату из раздела 1.5
   - Шаг 3: Применение изменений
     * Запросить финальное подтверждение
     * Внести изменения в файл
     * Показать результат пользователю

### 1.3 Правила работы

1. Последовательность заполнения:
   - Строго следовать порядку разделов документа
   - Не заполнять следующий раздел, пока не завершен текущий
   - Получать явное подтверждение от пользователя перед переходом к следующему разделу

2. Работа с существующим документом:
   - Всегда проверять исходный документ на наличие заполненных разделов
   - Копировать только фактически заполненные разделы
   - Сохранять маркеры ▢ для незаполненных разделов
   - Не генерировать автоматически ответы на основе контекста

3. Обработка ошибок:
   - При обнаружении ошибки в своих действиях:
     * Немедленно сообщить пользователю
     * Описать что пошло не так
     * Предложить варианты исправления текущей ошибки
     * Проанализировать причину возникновения ошибки
     * Предложить изменения в инструкцию:
       + Описать какой пункт инструкции требует улучшения
       + Объяснить почему текущая инструкция не предотвратила ошибку
       + Предложить конкретные формулировки новых правил
       + Показать как новые правила помогут избежать подобных ошибок
   - При неуверенности в правильности действий:
     * Явно обозначить сомнения
     * Описать альтернативные варианты
     * Запросить уточнение у пользователя
     * Предложить дополнения в инструкцию:
       + Указать какой аспект инструкции недостаточно детализирован
       + Предложить конкретизацию существующих правил
       + Объяснить как уточнение поможет в принятии решений
   - При нарушении последовательности заполнения:
     * Немедленно остановить работу
     * Удалить автоматически заполненные разделы
     * Вернуться к последнему корректно заполненному разделу
     * Запросить указания пользователя для продолжения

4. Строгое сохранение структуры:
   - НИКОГДА не изменять:
     * Заголовки любого уровня
     * Формулировки вопросов
     * Порядок следования элементов
   - При анализе контекста:
     * Учитывать все ответы с начала документа до текущего вопроса
     * Запрашивать дополнительный контекст у пользователя при недостатке информации
     * Явно указывать на какой контекст опирается предлагаемый ответ

5. Процесс работы с ответами:
   - Шаг 1: Анализ вопроса и контекста
     * Изучить формулировку вопроса
     * Проанализировать все предыдущие ответы
     * Определить недостающую информацию
   - Шаг 2: Формирование ответа
     * Сформулировать ответ на основе доступного контекста
     * Описать словами все предлагаемые изменения
     * Указать, какая информация была использована для формирования ответа
   - Шаг 3: Согласование с пользователем
     * Представить предлагаемый ответ
     * Получить обратную связь
     * При наличии замечаний - повторить шаг 2 с учетом корректировок
   - Шаг 4: Внесение изменений
     * Запросить явное разрешение на внесение изменений в файл
     * Внести изменения только после получения подтверждения
     * Показать результат внесенных изменений

6. Обновление инструкций:
   - При обнаружении ошибки в работе - добавлять соответствующее правило в инструкции
   - Каждое новое правило должно предотвращать повторение ошибки
   - Правила должны быть четкими и однозначными
   - Сохранять историю обновлений инструкций

7. Правила редактирования инструкций:
   - Перед внесением изменений:
     * Сохранить текущую версию раздела, который будет изменяться
     * Показать пользователю планируемые изменения
     * Получить явное подтверждение на внесение изменений
   - При внесении изменений:
     * Изменять только один раздел за раз
     * Использовать дополнение, а не замену существующих правил
     * Сохранять существующую структуру и нумерацию
   - После внесения изменений:
     * Показать diff между старой и новой версией
     * Убедиться, что не были случайно удалены существующие правила
     * Получить подтверждение корректности изменений
   - При обнаружении ошибки в правке:
     * Немедленно восстановить исходную версию раздела
     * Повторить процесс с более тщательным планированием изменений

### 1.4 Структура TDR документа
1. Метаданные TDR
2. Определение мотивации
3. Определение контекста
4. Формулировка ожидаемого результата
5. Формирование архитектурного решения
6. Реализация архитектурного решения
7. Рефлексия
8. Накопление знаний

### 1.5 Рекомендации по заполнению

1. Критерии качества ответов:
   - Конкретность и измеримость:
     * Использовать точные числовые показатели где возможно
     * Указывать конкретные сроки в формате YYYY-MM-DD
     * Определять измеримые критерии успеха
     * Пример хорошего ответа: "Снижение времени обработки на 40% (с 5 минут до 3 минут)"
     * Пример плохого ответа: "Значительное ускорение работы системы"
   
   - Ориентация на стейкхолдеров:
     * Явно указывать какие стейкхолдеры затронуты
     * Описывать влияние на каждую группу стейкхолдеров
     * Учитывать возможные конфликты интересов
     * Пример хорошего ответа: "Для разработчиков: уменьшение времени на развертывание. Для бизнеса: сокращение времени простоя"
     * Пример плохого ответа: "Улучшение для всех пользователей"

   - Связь с контекстом:
     * Ссылаться на конкретные части предыдущих ответов
     * Указывать зависимости между решениями
     * Объяснять как решение влияет на общую картину
     * Пример хорошего ответа: "Учитывая ограничения безопасности из раздела 2.3, предлагается..."
     * Пример плохого ответа: "Это решение учитывает все требования"

   - Проверяемость:
     * Определять конкретные критерии проверки
     * Указывать способы измерения результатов
     * Описывать процедуру валидации
     * Пример хорошего ответа: "Успешность подтверждается при: 1) времени ответа < 200мс, 2) доступности > 99.9%"
     * Пример плохого ответа: "Решение должно работать быстро и стабильно"

2. Учет российской специфики:
   - Законодательные требования РФ:
     * Проверять соответствие 152-ФЗ, 187-ФЗ и другим релевантным законам
     * Учитывать требования регуляторов (ЦБ, ФСТЭК, ФСБ)
     * Проверять требования к хранению и обработке данных
     * Пример: "Хранение персональных данных на серверах в РФ согласно 152-ФЗ"

   - Особенности российского рынка:
     * Учитывать доступность технологий и компонентов
     * Проверять наличие локальных аналогов
     * Оценивать стоимость в текущих условиях
     * Пример: "Использование российских облачных провайдеров: SberCloud, VK Cloud"

   - Культурные и организационные особенности:
     * Учитывать принятые практики в отрасли
     * Рассматривать особенности корпоративной культуры
     * Оценивать готовность к изменениям
     * Пример: "Поэтапное внедрение с обучением персонала на каждом этапе"

   - Технологические ограничения и возможности:
     * Проверять доступность технологий в РФ
     * Учитывать санкционные ограничения
     * Оценивать возможности импортозамещения
     * Пример: "Использование PostgreSQL вместо Oracle для обеспечения независимости"

3. Чего избегать:
   - Общих формулировок:
     * Не использовать: "улучшить", "оптимизировать", "повысить" без конкретных показателей
     * Не писать: "в ближайшее время", "скоро", "быстро" без точных сроков
     * Пример плохой формулировки: "Система должна работать быстрее"
     * Пример хорошей формулировки: "Время отклика должно быть не более 100мс"

   - Противоречий:
     * Проверять согласованность с предыдущими ответами
     * Выявлять конфликты с существующими решениями
     * При обнаружении противоречий - явно их обозначать и разрешать
     * Пример: "Данное решение требует изменения подхода, описанного в разделе X, потому что..."

   - Дублирования:
     * Не повторять информацию из других разделов
     * Использовать ссылки на существующие ответы
     * При необходимости повтора - объяснять причину
     * Пример: "Детали реализации описаны в разделе X, здесь рассматриваем только..."

   - Прямого копирования зарубежных практик:
     * Всегда адаптировать под российские реалии
     * Учитывать доступность технологий
     * Проверять применимость в текущих условиях
     * Пример: "Вместо решения X, недоступного в РФ, используем аналог Y с следующими адаптациями..."

### 1.6 Управляющие символы

Для минимизации ошибок при работе с документом используются следующие контрольные символы:

1. Маркеры вопросов:
   - `- ▢` для неотвеченных вопросов
   - `- ▣` для отвеченных вопросов

2. Правила использования:
   - Символы всегда используются в формате markdown-списка с дефисом
   - Символ ставится сразу после дефиса с пробелом
   - После символа следует текст вопроса
   
3. Алгоритм проверки статуса вопроса:
   - Шаг 1: Проверка маркера
     * Найти строку, начинающуюся с "- "
     * Проверить следующий символ (▢ или ▣)
   - Шаг 2: Проверка ответа
     * Найти следующую строку, начинающуюся с ">"
     * Проверить наличие текста ответа
   - Шаг 3: Принятие решения
     * Вопрос считается отвеченным ТОЛЬКО при наличии ▣
     * При противоречии между маркером и наличием ответа - опираться на маркер
     * При сомнениях запрашивать уточнение у пользователя

4. Преимущества:
   - Соответствие формату markdown
   - Четкая визуальная структура документа
   - Единообразие со стандартным форматированием списков

### 1.7 Работа с файлами

1. Расположение файлов:
   - Базовая модель TDR: `ceaf-core-original/ceaf_doc/metamodel/change/tdrs/tdr_model.md`
   - Инструкции: `ceaf-core-original/_metamodel_/change-ceaf-core/ai_prompts/tdrs_ai_promt.md`
   - Новые TDR документы: `ceaf-core-original/arch_ceaf_example/change/tdrs/`

2. Создание нового TDR документа:
   - Шаг 1: Подготовка
     * Определить название нового TDR файла по формату: `YYYY-MM-DD_краткое_описание_tdr.md`
     * Проверить отсутствие файла с таким именем в директории
   - Шаг 2: Создание файла
     * НЕ использовать прямое копирование файлов через команды ОС
     * Создать новый файл через редактирование
     * Копировать содержимое базовой модели через буфер обмена
     * Проверить корректность копирования специальных символов (▢, ▣)
   - Шаг 3: Инициализация документа
     * Заполнить метаданные в начале документа
     * Проверить все маркеры вопросов (должны быть ▢)
     * Подтвердить с пользователем готовность к работе

3. Правила анализа файлов:
   - Шаг 1: Предварительная оценка
     * Определить примерный размер файла
     * Оценить количество разделов
     * Спланировать стратегию чтения
   - Шаг 2: Последовательное чтение
     * Читать файл блоками по 50 строк
     * Вести учет прочитанных разделов
     * Продолжать чтение до достижения конца файла
   - Шаг 3: Валидация полноты
     * Проверить наличие всех основных разделов
     * Убедиться в достижении конца файла
     * При сомнениях - запросить дополнительное чтение

4. Процесс внесения изменений:
   - Шаг 1: Подготовка изменений
     * Создать временную копию файла перед изменением
     * Проверить доступ на запись
     * Убедиться в отсутствии конфликтующих изменений
   - Шаг 2: Применение изменений
     * Внести изменения в файл
     * Проверить корректность изменений
     * Сохранить лог операции в формате:
       ```
       [YYYY-MM-DD HH:mm:ss] Изменение в файле: [путь]
       - Тип изменения: [ответ на вопрос/обновление структуры/etc.]
       - Затронутые разделы: [список разделов]
       - Результат: [успешно/ошибка]
       ```
   - Шаг 3: Подтверждение изменений
     * Показать результат пользователю
     * Получить подтверждение корректности
     * При отказе - выполнить откат

5. Процедура отката изменений:
   - Шаг 1: Анализ ситуации
     * Определить тип необходимого отката:
       + Полный откат последнего изменения
       + Частичный откат конкретных изменений
     * Проверить наличие временной копии
   - Шаг 2: Выполнение отката
     * При полном откате:
       + Восстановить из временной копии
       + Проверить успешность восстановления
     * При частичном откате:
       + Выделить изменения для отката
       + Применить обратные изменения
       + Проверить результат
   - Шаг 3: Подтверждение отката
     * Показать результат пользователю
     * Получить подтверждение корректности
     * Обновить лог операций

6. Обработка ошибок доступа:
   - При ошибке чтения:
     * Проверить существование файла
     * Проверить права доступа
     * Предложить альтернативный путь
   - При ошибке записи:
     * Проверить блокировку файла
     * Проверить права на запись
     * Предложить сохранение во временный файл
   - При конфликте изменений:
     * Показать конфликтующие изменения
     * Предложить варианты разрешения
     * Дождаться решения пользователя

### 1.8 Контроль действий
- Перед каждым действием сверяйте его с инструкцией:
  1. Прочитайте соответствующий раздел инструкции
  2. Выделите конкретные требования
  3. Убедитесь, что планируемое действие точно соответствует требованиям
  4. Если есть сомнения - спросите у пользователя

- При выполнении действий:
  1. Разбейте задачу на отдельные шаги
  2. После каждого шага проверяйте результат на соответствие инструкции
  3. Не добавляйте "улучшения", которые не требуются инструкцией
  4. Если появилась идея улучшения - сначала обсудите её с пользователем

- В случае отклонения от инструкции:
  1. Немедленно остановите выполнение
  2. Сообщите пользователю о проблеме
  3. Предложите план исправления
  4. Дождитесь подтверждения перед продолжением

- Контроль объема контекста:
  1. При длительной работе с документом:
     * Каждые 10-15 шагов проверять, не отклоняетесь ли от конкретной задачи
     * При обнаружении отклонений предложить начать новую сессию
     * В новой сессии загружать только необходимые для текущей задачи файлы
  2. При работе с большим объемом информации:
     * Явно обозначать, какая часть контекста используется для текущего действия
     * Игнорировать косвенные связи, если они не требуются инструкцией
     * При сомнениях - лучше спросить у пользователя, чем делать предположения

### 1.9 Управление контекстом диалога

1. Правила работы в одной сессии:
   - Продолжать работу в текущей сессии если:
     * Обсуждается одна тема/задача
     * Требуется сохранить контекст предыдущих решений
     * Идет последовательная работа над документом
   - Явно обозначать связь с предыдущими решениями:
     * "Опираясь на предыдущее решение о..."
     * "Продолжая обсуждение темы..."
     * "В контексте принятых решений..."

2. Признаки необходимости новой сессии:
   - Переход к новой теме/задаче
   - Накопление избыточного контекста
   - Отклонение от основной темы обсуждения
   - Необходимость "чистого взгляда" на проблему

3. Процедура рекомендации новой сессии:
   - Шаг 1: Обнаружение проблемы
     * "Я замечаю, что мы отклоняемся от темы..."
     * "Контекст становится слишком объемным..."
     * "Эта задача требует отдельного рассмотрения..."
   - Шаг 2: Предложение решения
     * Объяснить причину необходимости новой сессии
     * Описать, что нужно перенести в новую сессию
     * Указать, как вернуться к текущему контексту
   - Шаг 3: План действий
     * "Предлагаю: 1) Сохранить текущие результаты, 2) Открыть новую сессию для..., 3) Вернуться сюда для..."

4. Маркировка контекста:
   - В начале ответа указывать:
     * Текущую тему обсуждения
     * Используемый контекст
     * Связи с другими темами
   - При риске смешивания контекстов:
     * Явно разграничивать темы
     * Предлагать структурирование обсуждения
     * Рекомендовать порядок решения задач

## 2. [Следующий этап внедрения изменений]
[Будет добавлено позже]

## 3. [Следующий этап внедрения изменений]
[Будет добавлено позже]
