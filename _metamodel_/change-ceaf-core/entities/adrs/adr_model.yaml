entities:  
  ceaf.change.adrs:
    title: Модель управления архитектурными решениями
    description: >
      При помощи данной сущности описываются архитектурные решения (architecture decision record)
    schema:
      type: object
      patternProperties:
        "[a-zA-Z0-9_]*(\\.[a-zA-Z0-9_]*)*$":
          type: object
          properties:
            title:
              title: Название ADR
              type: string
            description:
              title: Краткое описание рассматриваемого архитектурного решения
              type: string
          required:
            - title
            - description

    objects:
      adrs:
        route: "/"
        title: ADR
        symbol: "do"


    menu: >
      (
          $adrs := $."ceaf.change.adrs";
          $makeLocation := function($id) {(
              $arrleft := function($arr ,$count) {
                  $map($arr, function($v, $i) {
                  $i <= $count ? $v
                  })
              };
              $domains := $split($id, ".");
              "Архитектура/ADRs/" & $join($map($domains, function($domain, $index) {(
                  $lookup($adrs, $join($arrleft($domains, $index), ".")).title
                  )}), "/");
          )};

          $append([{
              "icon": *.icon,
              "link": "entities/ceaf.change.adrs/adl",
              "location": "Архитектура/ADRs"
          }],
              [$."ceaf.change.adrs".$spread().{
                  "icon": *.icon,
                  "link": "entities/ceaf.change.adrs/" & (($.*.presentation) ? $.*.presentation : "adr") & "?id=" & $keys()[0],
                  "location": $makeLocation($keys()[0]),
                  "order": *.order
              }][location]
          );
      )


    presentations: 
      adl:
        type: table
        headers:
          - value: title
            text: Наименование
            sortable: true
            align: left
            width: 40%
            link: link_to_adr

          - value: status
            text: Статус
            sortable: true
            align: left
            width: 10%

          - value: date
            text: Дата
            sortable: true
            align: left

          # - value: adr_id
          #   text: ID
          #   sortable: true
          #   align: left
          #   width: 10%
          #   link: link_to_adr

          - value: decision_level
            text: Уровень решения
            sortable: true
            align: left

          - value: doc_autor
            text: Автор решения
            sortable: true
            align: left

        source: >
          (
            $manifest := $;
            $dictionaries := $manifest."ceaf.ia.dictionaries";
            $adrs := $manifest."ceaf.change.adrs";
            [$adrs.$spread().(
              $adr_id:= $keys()[0];
              $adr:= $.*;
              $adr := $add_dictionary_value($adr.status, "status", $adr, $dictionaries."settings.adr.statuses".parameters);
              $adr := $add_dictionary_value($adr.decision_level, "decision_level", $adr, $dictionaries."settings.adr.decision_level".parameters);
              {
                "adr_id": $adr_id,
                "link_to_adr": "adr?id=" & $adr_id,
                "title": $adr.title,                
                "status": $adr.status.title,
                "date": $adr.date,
                "decision_level": $adr.decision_level.title,
                "doc_autor": $adr.author.name
              };
            )];
          )

      adr:
        type: markdown
        title: Выводим карточку ADR
        template: templates/adr_template.md
        source: >
          (
            $adr := $."ceaf.change.adrs".$spread().$merge([$.*, {"id": $keys($)}]);
            $adr [id=$params.id];
            
            /* Добавляем доп параметры для ADR*/
            $manifest := $;
            $dictionaries := $manifest."ceaf.ia.dictionaries";

            /* Статусы жизненного цикла*/
            $adr := $add_dictionary_value($adr.status, "status", $adr, $dictionaries."settings.adr.statuses".parameters);

            /* Уровень принятия решений*/
            $adr := $add_dictionary_value($adr.decision_level, "decision_level", $adr, $dictionaries."settings.adr.decision_level".parameters);
          )

      business_process:
        title: Выводим описанные бизнес-процессы
        # type: bpmnjs
        source: >
          (
            $docs := $.docs.$spread().$merge([$.*, {"id": $keys($)}]);
            $docs [id=$params.doc_id];
          )
        
        # Для теста
        # http://localhost:8080/entities/ceaf.change.adrs/business_process?doc_id=dochub.adr_001.created_process